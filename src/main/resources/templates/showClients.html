<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Show Clients</title>

    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.4.1/css/all.css"
          integrity="sha384-5sAR7xN1Nv6T6+dT2mhtzEpVJvfS3NScPQTrOxhwjIuvcA67KV2R5Jz6kr4abQsz"
          crossorigin="anonymous">
    <link th:href="@{styles/navigationstyle.css}" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Roboto', sans-serif;
        }

        .container {
            margin-top: 30px;
        }
        .table {
            background-color: white;
        }
        th {
            background-color: #1c87c9;
            color: white;
        }
        .btn {
            color: white;
            background-color: #1c87c9;
            border: none;
        }
        .btn:hover {
            background-color: #155b82;
        }
    </style>
</head>
<body>
<div th:replace="~{fragments/navigation :: header}"> </div>
<main role="main" class="flex-shrink-0" >
    <button id="fetchButton">Fetch Clients</button>
    <table class="table">
        <thead>
        <tr>
            <th>ID</th>
            <th>First Name</th>
            <th>Last Name</th>
            <th>CIN Number</th>
            <th>Delete</th>
            <th>Edit</th>

        </tr>
        </thead>
        <tbody id="clientList"></tbody>
    </table>

    <!-- ... custom dialog ... -->
    <div class="modal fade" id="editModal" tabindex="-1" role="dialog" aria-labelledby="editModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editModalLabel">Edit Client Information</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="editForm">
                        <div class="form-group">
                            <label for="editFirstName">First Name</label>
                            <input type="text" class="form-control" id="editFirstName" placeholder="Enter First Name">
                        </div>
                        <div class="form-group">
                            <label for="editLastName">Last Name</label>
                            <input type="text" class="form-control" id="editLastName" placeholder="Enter Last Name">
                        </div>
                        <div class="form-group">
                            <label for="editCIN">CIN Number</label>
                            <input type="text" class="form-control" id="editCIN" placeholder="Enter CIN Number">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="updateClientButton">Update</button>
                </div>
            </div>
        </div>
    </div>



    <script>
        document.getElementById("fetchButton").addEventListener("click", fetchClients);

        function fetchClients() {
            fetch("/allclients")  // Replace with your actual API endpoint
                .then(response => response.json())
                .then(clients => displayClients(clients))
                .catch(error => console.error("Error fetching clients:", error));
        }



        function displayClients(clients) {

            const clientListTable = document.getElementById("clientList");
            clientListTable.innerHTML = "";  // Clear previous content

            clients.forEach(client => {
                const row = clientListTable.insertRow();
                const idCell = row.insertCell(0);
                const firstNameCell = row.insertCell(1);
                const lastNameCell = row.insertCell(2);
                const cinCell = row.insertCell(3);
                const actionCell = row.insertCell(4);
                const actionCell2 = row.insertCell(5);

                idCell.textContent = client.id;
                firstNameCell.textContent = client.first_name;
                lastNameCell.textContent = client.name;
                cinCell.textContent = client.cin;

                const deleteButton = document.createElement("button");
                deleteButton.textContent = "Delete";
                deleteButton.addEventListener("click", () => deleteClient(client.id));
                actionCell.appendChild(deleteButton);

                const EditButton = document.createElement("button");
                EditButton.textContent = "Edit";
                EditButton.addEventListener("click", () => displayDialogAndform(client));  // please define the displayDialogandform fontion
                actionCell2.appendChild(EditButton);


            });
        }

        // Add a reference to the edit form
        function displayDialogAndform(client) {
            const editModal = $("#editModal");
            const editForm = document.getElementById("editForm");
            const editFirstName = document.getElementById("editFirstName");
            const editLastName = document.getElementById("editLastName");
            const editCIN = document.getElementById("editCIN");

            // Set client data in the form fields
            editFirstName.value = client.first_name;
            editLastName.value = client.name;
            editCIN.value = client.cin;

            // Show the modal
            editModal.modal("show");

            // Handle the update button click
            document.getElementById("updateClientButton").addEventListener("click", () => {
                const updatedClient = {
                    first_name: editFirstName.value,
                    name: editLastName.value,
                    cin: editCIN.value
                };

                // Update the client information
                updateClient(client.id, updatedClient);

                // Close the modal
                editModal.modal("hide");
            });
        }
        function updateClient(clientid,updatedClient){

            fetch(`/updateClient/${updatedClient.cin}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(updatedClient)
            })
                .then(response => {
                    if (response.ok) {
                        // Show a success message or perform any desired action
                        $("#editModal").modal("hide");
                        fetchClients()
                        console.log("Client information updated successfully");
                    } else {

                        console.error("Error updating client information:", response.statusText);
                    }
                })
                .catch(error => console.error("Error updating client information:", error));


        }


        function deleteClient(clientId) {
            fetch(`/client/delete/${clientId}`, {
                method: 'DELETE'
            })
            .then(response => {
                if (response.ok) {
                    // Refresh the client list after deletion
                    fetchClients();
                } else {
                    console.error("Error deleting client:", response.statusText);
                }
            })
            .catch(error => console.error("Error deleting client:", error));
        }




        </script>

    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js">




        // fetchClients();
        // $(editModal).modal("hide");

    </script>

</main>
</body>
</html>
